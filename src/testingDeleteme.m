
dx = 1009;
dy = 1013;
dz = 1019;
mx = 11;
my = 13;
mz = 17;
mu = 1;
nu = 0.28;
[vertices, B, xnodes, mno, nc, n, D, kg, w, h, d, mx, my, mz, mel] = finiteElement3D(dx, dy, dz, mx, my, mz, mu, nu);

idx = [
        9   3
        9  18
        6   5
        5  20
        10  9
    ];
xnodes(idx(1,:), :)
idxCon = [6,8,3,1,5];
idxNode = [1703,2430,592,1732,976];
nc(idxNode, idxCon)


idxK = [3435, 3400;
 1108, 1069;
 8973, 9009;
 3019, 3664;
 6670, 6706;
 5488, 4840;
 675, 29;
 1042, 357;
 5710, 5096;
 1918, 1275;
];

kg(idxK(:,1), idxK(:,2));

%%

dx = 2000;
dy = 2000;
dz = 2000;
mx = 5;
my = 5;
mz = 5;
mu = 1;
nu = 0.28;
[vertices, B, xnodes, mno, nc, n, D, kg, w, h, d, mx, my, mz, mel] = finiteElement3D(dx, dy, dz, mx, my, mz, mu, nu);

uhat = zeros(3*mno, 1);
tic;
uhat([91;126;130;195;217;226;229;256;281;293;309;342], 1) = 1000*[0.5231621885339968, 0.5771429489788034, 0.7151190318538345, 0.7283662326812077, 0.6314274719472075, 0.9814688915693632, 0.5672795171250207, 0.002712918060655989, 0.1788941754890383, 0.188299784057536, 0.8489027048214433, 0.029995302953659708];
hatStress(uhat, nc, xnodes, D, mx, mz, w, h, d, [1575.,985.,1341.])
toc;

hatStress(uhat, nc, xnodes, D, mx, mz, w, h, d, [1893.0, 408.0, 1782.0])

links = [1.0 2.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 2.0 3.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 3.0 4.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 4.0 5.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 5.0 6.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 6.0 7.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 7.0 8.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 8.0 1.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 9.0 10.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 10.0 11.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 11.0 12.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 12.0 13.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 13.0 14.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 14.0 15.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 15.0 16.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 16.0 9.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 17.0 18.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 18.0 19.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 19.0 20.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 20.0 21.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 21.0 22.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 22.0 23.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 23.0 24.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 24.0 17.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 25.0 26.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 26.0 27.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 27.0 28.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 28.0 29.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 29.0 30.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 30.0 31.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 31.0 32.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0; 32.0 25.0 -0.5773502691896258 0.5773502691896258 0.5773502691896258 0.7071067811865475 0.7071067811865475 0.0];

rn = [1201.5837679702274 696.4782710631935 1219.6759003965913 0.0; 1283.233426063 614.8286129704209 1382.9752165821365 0.0; 1424.6547823003095 756.2499692077304 1382.9752165821365 0.0; 1566.076138537619 897.6713254450399 1382.9752165821365 0.0; 1484.4264804448464 979.3209835378125 1219.6759003965913 0.0; 1402.7768223520739 1060.970641630585 1056.376584211046 0.0; 1261.3554661147643 919.5492853932756 1056.376584211046 0.0; 1119.9341098774548 778.1279291559661 1056.376584211046 0.0; 304.6214867750916 302.5604363129223 1604.4473849682922 0.0; 386.2711448678642 220.91077822014972 1767.7467011538374 0.0; 527.6925011051737 362.33213445745923 1767.7467011538374 0.0; 669.1138573424832 503.75349069476874 1767.7467011538374 0.0; 587.4641992497106 585.4031487875413 1604.4473849682922 0.0; 505.81454115693805 667.0528068803139 1441.148068782747 0.0; 364.39318491962854 525.6314506430044 1441.148068782747 0.0; 222.97182868231897 384.210094405695 1441.148068782747 0.0; 1270.8257124306385 1055.3880794417687 951.679209138293 0.0; 1352.4753705234111 973.7384213489961 1114.9785253238383 0.0; 1467.9454243613363 858.2683675110709 999.5084714859131 0.0; 1583.4154781992615 742.7983136731457 884.038417647988 0.0; 1501.765820106489 824.4479717659183 720.7391014624428 0.0; 1420.1161620137163 906.0976298586909 557.4397852768976 0.0; 1304.6461081757911 1021.5676836966161 672.9098391148227 0.0; 1189.176054337866 1137.0377375345413 788.3798929527478 0.0; 462.2031932442291 1195.4446644351433 1431.0547935274708 0.0; 543.8528513370018 1113.7950063423707 1594.354109713016 0.0; 659.3229051749269 998.3249525044455 1478.8840558750908 0.0; 774.792959012852 882.8548986665203 1363.4140020371656 0.0; 693.1433009200794 964.5045567592929 1200.1146858516204 0.0; 611.4936428273068 1046.1542148520655 1036.8153696660752 0.0; 496.02358898938166 1161.6242686899907 1152.2854235040004 0.0; 380.5535351514565 1277.094322527916 1267.7554773419254 0.0];

segments = constructsegmentlist(rn, links, true);

% f = @() pkforcevec(uhat, nc, xnodes, D, mx, mz, w, h, d, segments);
% timeit(f)

fPK = pkforcevec(uhat, nc, xnodes, D, mx, mz, w, h, d, segments)
%%
mu = 1;
nu = 0.28;
numNode = 2;
numSeg = numNode - 1;
len = numNode + 1;
xrange = linspace(-300, 300, len);
yrange = linspace(-300, 300, len);

X = xrange .* ones(length(yrange))';
Y = yrange' .* ones(length(xrange));
Z = zeros(length(xrange))' .* zeros(len);
points = [X(:) Y(:) Z(:)];

l = [0; 0; 1];
b = [1; 0; 0];
n = cross(b, l);
a = 5 * norm(b);

links = zeros(numSeg, 2);
slipPlane = zeros(numSeg, 3);
bVec = zeros(numSeg, 3);
rn = [zeros(len, 1) zeros(len, 1) xrange'];
label = zeros(len, 1);
for i = 1:numSeg
    links(i, :) = [i, i + 1];
    slipPlane(i, :) = n;
    bVec(i, :) = b;
end
links = [links bVec slipPlane];

segments = constructsegmentlist(rn, links, true);
x1 = segments(:, 6:8);
x2 = segments(:, 9:11);
b = segments(:, 3:5);

stress = FieldPointStress(points, x1, x2, b, a, mu, nu);

%%

mu = 1;
nu = 0.28;
numNode = 2;
numSeg = numNode - 1;
len = numNode + 1;
xrange = linspace(-300, 300, len);
yrange = linspace(-300, 300, len);

X = xrange .* ones(length(yrange))';
Y = yrange' .* ones(length(xrange));
Z = zeros(length(xrange))' .* zeros(len);
points = [X(:) Y(:) Z(:)];

l = [0; 0; 1];
b = [0; 0; 1];
n = cross(b, l);
a = 5 * norm(b);

links = zeros(numSeg, 2);
slipPlane = zeros(numSeg, 3);
bVec = zeros(numSeg, 3);
rn = [zeros(len, 1) zeros(len, 1) xrange'];
label = zeros(len, 1);
for i = 1:numSeg
    links(i, :) = [i, i + 1];
    slipPlane(i, :) = n;
    bVec(i, :) = b;
end
links = [links bVec slipPlane];

segments = constructsegmentlist(rn, links, true);
x1 = segments(:, 6:8);
x2 = segments(:, 9:11);
b = segments(:, 3:5);

stress = FieldPointStress(points, x1, x2, b, a, mu, nu);
%%

mx = 3;
my = 5;
mz = 7;
dx = 1013.0;
dy = 1987.0;
dz = 2999.0;
nu = 0.28;
mu = 1;

[vertices, B, xnodes, mno, nc, n, D, kg, w, h, d, mx, my, mz, mel] = ...
    finiteElement3D(dx, dy, dz, mx, my, mz, mu, nu);
simType = @cantileverBending;
[K, L, U, P_l, P_u, Sleft, Sright, Stop, Sbot, Sfront, Sback, Smixed, gammat, ...
        gammau, gammaMixed, fixedDofs, freeDofs, processForceDisp, plotForceDisp] = ...
    simType(kg, w, h, d, mno, mx, my, mz);

gnl = [gammau(:, 1); gammaMixed(:, 1)];

coord =  [718.0     863.636  1417.86
 675.742  1021.34   1302.41
 534.345  1162.74   1302.41
 376.636  1205.0    1417.86
 295.0    1123.36   1581.14
 337.258   965.655  1696.59
 478.655   824.258  1696.59
 636.364   782.0    1581.14
 686.679  1173.68   1557.23
 662.769  1149.77   1360.14
 547.318  1034.32   1244.69
 407.957   894.957  1278.5
 326.321   813.321  1441.77
 350.231   837.231  1638.86
 465.682   952.682  1754.31
 605.043  1092.04   1720.5];

label = zeros(16, 1);

links = [1   2
  2   3
  3   4
  4   5
  5   6
  6   7
  7   8
  8   1
  9  10
 10  11
 11  12
 12  13
 13  14
 14  15
 15  16
 16   9];

b = [0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735
 0.57735  0.57735  0.57735];

slip = [-0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0
 -0.707107  0.707107  0.0];
links = [links b slip];
rn = [coord label];

u_tilda_0 = zeros(3*mno,1);
gnl = [1, 161, 29, 189, 33, 65, 97, 129, 61, 93, 125, 157, 5, 9, 13, 17, 21, 25, 165, 169, 173, 177, 181, 185, 37, 41, 45, 49, 53, 57, 69, 73, 77, 81, 85, 89, 101, 105, 109, 113, 117, 121, 133, 137, 141, 145, 149, 153, 32, 192, 64, 96, 128, 160]';
% gnl = sort(gnl);
[ux, uy, uz] = Utilda_bb_vec(rn, links, gnl, nu, xnodes, dx, dy, dz, mx, my, mz);

u_tilda_0(3 * gnl - 2) = ux;
    u_tilda_0(3 * gnl - 1) = uy;
    u_tilda_0(3 * gnl) = uz;
% u_tilda_0 = calculateUtilda(rn, links, gnl, nu, xnodes, dx, ...
%     dy, dz, mx, my, mz, u_tilda_0);
% 
% u_tilda_0

%%
function f = pkforcevec(uhat, nc, xnodes, D, mx, mz, w, h, d, segments)
    %nodal force on dislocation segments due to applied stress sigext
    %(vectorized version)
    %format of segments array:
    % (n0,n1,bx,by,bz,x0,y0,z0,x1,y1,z1,nx,ny,nz)
    [nseg, ~] = size(segments);
    f = zeros(nseg, 3);

    b = segments(:, 3:5);
    r0 = segments(:, 6:8);
    r1 = segments(:, 9:11);
    r01 = r1 - r0;
    rmid = 0.5 * (r0 + r1);

    for i = 1:nseg% evaluate sigmahat at midpoint of each segment (do something better later)
        xi = rmid(i, 1:3);

        if any(isnan(xi))
            fprintf('Segment midpoint is undefined! See segforcevec.m\n');
            pause;
        end

        sigext = hatStress(uhat, nc, xnodes, D, mx, mz, w, h, d, xi); %must not pass virtsegs!

        sigb = sigext * b(i, 1:3)';
        l = r01(i, :);
        f(i, :) = cross(sigb', l);
    end

end
